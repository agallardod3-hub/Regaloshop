# =============================================================================
# WORKFLOW: Pruebas Unitarias con Jest y AnÃ¡lisis SonarQube
# Ejecuta los tests automaticamente en cada push o pull request
# =============================================================================

name: ðŸ§ª Pruebas Unitarias y SonarQube

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

jobs:
  tests:
    name: Ejecutar Tests y AnÃ¡lisis
    runs-on: ubuntu-latest

    steps:
      # -----------------------------------------------------------------------
      # Paso 1: Descargar el codigo del repositorio
      # -----------------------------------------------------------------------
      - name: ðŸ“¥ Descargar codigo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # -----------------------------------------------------------------------
      # Paso 2: Configurar Node.js
      # -----------------------------------------------------------------------
      - name: ðŸŸ¢ Configurar Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: backend/package-lock.json

      # -----------------------------------------------------------------------
      # Paso 3: Instalar dependencias
      # -----------------------------------------------------------------------
      - name: ðŸ“¦ Instalar dependencias
        working-directory: backend
        run: npm ci

      # -----------------------------------------------------------------------
      # Paso 4: Ejecutar tests con cobertura
      # -----------------------------------------------------------------------
      - name: ðŸ§ª Ejecutar pruebas unitarias
        working-directory: backend
        run: npm test -- --verbose --coverage --coverageReporters=lcov --coverageReporters=text 2>&1 | tee test-output.txt

      # -----------------------------------------------------------------------
      # Paso 5: Publicar resultado en GitHub Summary
      # -----------------------------------------------------------------------
      - name: ðŸ“Š Publicar resumen de tests
        working-directory: backend
        if: always()
        run: |
          echo "## ðŸ§ª Resultado de Pruebas Unitarias" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          cat test-output.txt >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

      # -----------------------------------------------------------------------
      # Paso 6: Iniciar SonarQube en Docker
      # -----------------------------------------------------------------------
      - name: ðŸ³ Iniciar SonarQube
        run: |
          docker run -d --name sonarqube -p 9000:9000 \
            -e SONAR_ES_BOOTSTRAP_CHECKS_DISABLE=true \
            sonarqube:lts-community
          
          echo "Esperando que SonarQube inicie (~2 minutos)..."
          for i in $(seq 1 60); do
            STATUS=$(curl -s http://localhost:9000/api/system/status 2>/dev/null | jq -r '.status' 2>/dev/null || echo "")
            if [ "$STATUS" = "UP" ]; then
              echo "âœ… SonarQube esta listo!"
              exit 0
            fi
            echo "Intento $i/60 - Estado: $STATUS"
            sleep 5
          done
          echo "âŒ SonarQube no inicio a tiempo"
          docker logs sonarqube
          exit 1

      # -----------------------------------------------------------------------
      # Paso 7: Configurar proyecto en SonarQube
      # -----------------------------------------------------------------------
      - name: ðŸ”§ Configurar proyecto en SonarQube
        run: |
          # Cambiar contraseÃ±a por defecto
          curl -s -u admin:admin -X POST "http://localhost:9000/api/users/change_password?login=admin&previousPassword=admin&password=admin123" || true
          
          # Crear proyecto
          curl -s -u admin:admin123 -X POST "http://localhost:9000/api/projects/create?name=Regaloshop&project=regaloshop"
          
          # Generar token
          TOKEN=$(curl -s -u admin:admin123 -X POST "http://localhost:9000/api/user_tokens/generate?name=github-action" | jq -r '.token')
          echo "SONAR_TOKEN=$TOKEN" >> $GITHUB_ENV
          echo "âœ… Proyecto configurado"

      # -----------------------------------------------------------------------
      # Paso 8: Ejecutar anÃ¡lisis SonarQube
      # -----------------------------------------------------------------------
      - name: ðŸ” AnÃ¡lisis SonarQube
        run: |
          # Descargar SonarScanner
          wget -q https://binaries.sonarsource.com/Distribution/sonar-scanner-cli/sonar-scanner-cli-5.0.1.3006-linux.zip
          unzip -q sonar-scanner-cli-5.0.1.3006-linux.zip
          
          # Ejecutar anÃ¡lisis
          ./sonar-scanner-5.0.1.3006-linux/bin/sonar-scanner \
            -Dsonar.projectKey=regaloshop \
            -Dsonar.projectName=Regaloshop \
            -Dsonar.sources=backend/src \
            -Dsonar.tests=backend/tests \
            -Dsonar.javascript.lcov.reportPaths=backend/coverage/lcov.info \
            -Dsonar.host.url=http://localhost:9000 \
            -Dsonar.token=$SONAR_TOKEN

      # -----------------------------------------------------------------------
      # Paso 9: Obtener y publicar resultados de SonarQube
      # -----------------------------------------------------------------------
      - name: ðŸ“Š Publicar resultados SonarQube
        if: always()
        run: |
          sleep 15
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ðŸ” AnÃ¡lisis de Calidad - SonarQube" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Obtener mÃ©tricas
          METRICS=$(curl -s -u admin:admin123 "http://localhost:9000/api/measures/component?component=regaloshop&metricKeys=bugs,vulnerabilities,code_smells,coverage,duplicated_lines_density,ncloc" 2>/dev/null || echo '{}')
          
          BUGS=$(echo $METRICS | jq -r '.component.measures[]? | select(.metric=="bugs") | .value // "0"' 2>/dev/null || echo "0")
          VULNS=$(echo $METRICS | jq -r '.component.measures[]? | select(.metric=="vulnerabilities") | .value // "0"' 2>/dev/null || echo "0")
          SMELLS=$(echo $METRICS | jq -r '.component.measures[]? | select(.metric=="code_smells") | .value // "0"' 2>/dev/null || echo "0")
          COV=$(echo $METRICS | jq -r '.component.measures[]? | select(.metric=="coverage") | .value // "N/A"' 2>/dev/null || echo "N/A")
          DUP=$(echo $METRICS | jq -r '.component.measures[]? | select(.metric=="duplicated_lines_density") | .value // "0"' 2>/dev/null || echo "0")
          LINES=$(echo $METRICS | jq -r '.component.measures[]? | select(.metric=="ncloc") | .value // "0"' 2>/dev/null || echo "0")
          
          echo "| MÃ©trica | Valor |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ“ LÃ­neas de CÃ³digo | $LINES |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ› Bugs | $BUGS |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ”“ Vulnerabilidades | $VULNS |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ”§ Code Smells | $SMELLS |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ“Š Cobertura | ${COV}% |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ“‹ CÃ³digo Duplicado | ${DUP}% |" >> $GITHUB_STEP_SUMMARY
