# =============================================================================
# WORKFLOW: Pruebas Unitarias con Jest y AnÃ¡lisis SonarQube
# Ejecuta los tests automaticamente en cada push o pull request
# =============================================================================

name: ðŸ§ª Pruebas Unitarias y SonarQube

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

jobs:
  tests:
    name: Ejecutar Tests y AnÃ¡lisis
    runs-on: ubuntu-latest

    services:
      sonarqube:
        image: sonarqube:lts-community
        ports:
          - 9000:9000
        env:
          SONAR_ES_BOOTSTRAP_CHECKS_DISABLE: true
        options: >-
          --health-cmd "curl -f http://localhost:9000/api/system/status || exit 1"
          --health-interval 30s
          --health-timeout 10s
          --health-retries 10
          --health-start-period 120s

    steps:
      # -----------------------------------------------------------------------
      # Paso 1: Descargar el codigo del repositorio
      # -----------------------------------------------------------------------
      - name: ðŸ“¥ Descargar codigo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # -----------------------------------------------------------------------
      # Paso 2: Configurar Node.js
      # -----------------------------------------------------------------------
      - name: ðŸŸ¢ Configurar Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: backend/package-lock.json

      # -----------------------------------------------------------------------
      # Paso 3: Instalar dependencias
      # -----------------------------------------------------------------------
      - name: ðŸ“¦ Instalar dependencias
        working-directory: backend
        run: npm ci

      # -----------------------------------------------------------------------
      # Paso 4: Ejecutar tests con cobertura
      # -----------------------------------------------------------------------
      - name: ðŸ§ª Ejecutar pruebas unitarias
        working-directory: backend
        run: npm test -- --verbose --coverage --coverageReporters=lcov --coverageReporters=text 2>&1 | tee test-output.txt

      # -----------------------------------------------------------------------
      # Paso 5: Publicar resultado en GitHub Summary
      # -----------------------------------------------------------------------
      - name: ðŸ“Š Publicar resumen en GitHub Summary
        working-directory: backend
        if: always()
        run: |
          echo "## ðŸ§ª Resultado de Pruebas Unitarias" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          cat test-output.txt >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY

      # -----------------------------------------------------------------------
      # Paso 6: Esperar que SonarQube este listo
      # -----------------------------------------------------------------------
      - name: â³ Esperar SonarQube
        run: |
          echo "Esperando que SonarQube inicie..."
          for i in {1..30}; do
            if curl -s http://localhost:9000/api/system/status | grep -q '"status":"UP"'; then
              echo "SonarQube esta listo!"
              break
            fi
            echo "Intento $i/30 - SonarQube aun no esta listo..."
            sleep 10
          done

      # -----------------------------------------------------------------------
      # Paso 7: Crear proyecto en SonarQube
      # -----------------------------------------------------------------------
      - name: ï¿½ Configurar proyecto en SonarQube
        run: |
          # Cambiar contraseÃ±a por defecto (admin/admin -> admin/admin123)
          curl -u admin:admin -X POST "http://localhost:9000/api/users/change_password?login=admin&previousPassword=admin&password=admin123" || true
          
          # Crear proyecto
          curl -u admin:admin123 -X POST "http://localhost:9000/api/projects/create?name=Regaloshop&project=regaloshop"
          
          # Generar token
          TOKEN=$(curl -u admin:admin123 -X POST "http://localhost:9000/api/user_tokens/generate?name=github-action" | jq -r '.token')
          echo "SONAR_TOKEN=$TOKEN" >> $GITHUB_ENV

      # -----------------------------------------------------------------------
      # Paso 8: Instalar SonarScanner
      # -----------------------------------------------------------------------
      - name: ðŸ“¥ Instalar SonarScanner
        run: |
          wget -q https://binaries.sonarsource.com/Distribution/sonar-scanner-cli/sonar-scanner-cli-5.0.1.3006-linux.zip
          unzip -q sonar-scanner-cli-5.0.1.3006-linux.zip
          echo "$PWD/sonar-scanner-5.0.1.3006-linux/bin" >> $GITHUB_PATH

      # -----------------------------------------------------------------------
      # Paso 9: Ejecutar anÃ¡lisis SonarQube
      # -----------------------------------------------------------------------
      - name: ðŸ” AnÃ¡lisis SonarQube
        run: |
          sonar-scanner \
            -Dsonar.projectKey=regaloshop \
            -Dsonar.sources=backend/src \
            -Dsonar.tests=backend/tests \
            -Dsonar.javascript.lcov.reportPaths=backend/coverage/lcov.info \
            -Dsonar.host.url=http://localhost:9000 \
            -Dsonar.token=$SONAR_TOKEN

      # -----------------------------------------------------------------------
      # Paso 10: Obtener resultados de SonarQube
      # -----------------------------------------------------------------------
      - name: ðŸ“Š Obtener resultados SonarQube
        if: always()
        run: |
          sleep 10
          echo "## ðŸ” Resultado AnÃ¡lisis SonarQube" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Obtener mÃ©tricas
          METRICS=$(curl -s -u admin:admin123 "http://localhost:9000/api/measures/component?component=regaloshop&metricKeys=bugs,vulnerabilities,code_smells,coverage,duplicated_lines_density")
          
          echo "| MÃ©trica | Valor |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ› Bugs | $(echo $METRICS | jq -r '.component.measures[] | select(.metric=="bugs") | .value // "0"') |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ”“ Vulnerabilidades | $(echo $METRICS | jq -r '.component.measures[] | select(.metric=="vulnerabilities") | .value // "0"') |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ”§ Code Smells | $(echo $METRICS | jq -r '.component.measures[] | select(.metric=="code_smells") | .value // "0"') |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ“Š Cobertura | $(echo $METRICS | jq -r '.component.measures[] | select(.metric=="coverage") | .value // "N/A"')% |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ“‹ CÃ³digo Duplicado | $(echo $METRICS | jq -r '.component.measures[] | select(.metric=="duplicated_lines_density") | .value // "0"')% |" >> $GITHUB_STEP_SUMMARY
